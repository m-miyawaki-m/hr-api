name: CI - Test and Build

# ワークフローの実行トリガー
on:
    # mainブランチへのpush時
    push:
        branches: [main, develop]
    # プルリクエスト作成時
    pull_request:
        branches: [main, develop]
    # 手動実行を許可
    workflow_dispatch:

# 権限の設定
permissions:
    contents: read
    checks: write
    pull-requests: write

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            # リポジトリのチェックアウト
            - name: Checkout repository
              uses: actions/checkout@v4

            # Java 21のセットアップ
            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            # Gradleの実行権限を付与
            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            # Gradleの依存関係をキャッシュ
            - name: Cache Gradle packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            # テストの実行
            - name: Run tests
              run: ./gradlew test

            # テストレポートのアップロード（テストが失敗した場合でも実行）
            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results
                  path: build/reports/tests/test/
                  retention-days: 30

            # JaCoCo テストカバレッジレポートの生成
            - name: Generate test coverage report
              run: ./gradlew jacocoTestReport
              continue-on-error: true

            # テストカバレッジレポートのアップロード
            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-reports
                  path: build/reports/jacoco/test/
                  retention-days: 30

            # テスト結果をPRにコメントとして投稿
            - name: Publish test results
              uses: EnricoMi/publish-unit-test-result-action@v2
              if: always()
              with:
                  files: |
                      build/test-results/test/*.xml
                  check_name: "Test Results"
                  comment_mode: create new
                  fail_on: "test failures"

            # Gradleビルドの実行
            - name: Build with Gradle
              run: ./gradlew build -x test

            # ビルド成果物のアップロード
            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  path: build/libs/
                  retention-days: 7

    # コードの静的解析（SpotBugs、Checkstyle等）
    code-quality:
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Cache Gradle packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            # コードフォーマットチェック（Spotless）
            - name: Check code formatting
              run: ./gradlew spotlessCheck

            # 静的解析レポートのアップロード
            - name: Upload code quality reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: code-quality-reports
                  path: build/reports/
                  retention-days: 30
